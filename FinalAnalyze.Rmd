---
title: "Final Analysis"
author: "Nam Nguyen & Hailey Nguyen"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::pdf_document2
spacing: double
knit: (function(inputFile, encoding) { 
      out_dir <- 'pdf';
      out_file <- sub(".Rmd", ".pdf", basename(normalizePath(inputFile)));
      rmarkdown::render(inputFile,encoding=encoding, 
                        output_file = file.path(dirname(inputFile), out_dir, out_file))})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

if (getwd() != "~/STAT209/Final") {
  setwd("~/STAT209/Final")
}
```

```{r library}
library(tidyverse)
library(maps)
library(janitor)
library(expss)
library(kableExtra)
library(patchwork)
library(xtable)
library(glmnet)
library(tidymodels)
library(ggdist)
```

# Introduction

## What our research about?
In 2019, pollution accounts for approximately 9 million deaths, equivalent to a staggering 1 out of 6 fatalities, and this number has not seen any significant change since then. We aim to answer our research questions: “How do various environmental exposures impact health burden measured by Disability-Adjusted Life Years (DALYs) across different socio-economic settings?”. 

It is common knowledge that environmental exposures could affect physical health, but there has not been much discourse on the mental distress caused by pollution. This paper would add to the literature of pollution exposures’ effect on both non-communicable and communicable diseases. On communicable diseases, Young-Min Kim et al investigates the effect of chemicals generated by waste incinerators in Korea on exposure to airborne diseases, and finds out that NO2 ranked highest in all-cause mortality, and this effect is amplified when population exposure is accounted for. Regarding non-communicable diseases. Paul A Peters, Zhiqiang John Zhai discovered that exposure to pollutants can increase the risk for neuro-developmental disorders. Through this project, we hope to utilize our results to make suggestions to public health policy and global health evaluations. We also hope to gain more insights into:
\begin{enumerate}
  \item How does mental illness and energy populations contributes to DALYs?
  \item Does socio-ecomonic and geographic factors contributes to DALYs?
\end{enumerate}

# Data

## Data Source

Before dive into further analysis, we want to define DALYs as the total of years lost due to premature death or total years lost due to disabilities of a country.
Our data is extracted from Kaggle and composes of three main datasets: Life Expectancy & Socio-Economic dataset, Mental Disorder dataset and Sustainable Energy dataset. Our first dataset contains both demographic (Region; Income Level) and socioeconomic attributes (GDP; Health & Education Expenditure; Unemployment; Percentage of undernourished population; Life Expectancy). The second dataset focuses on non-communicable diseases, containing information on Percentage of the population who have certain mental health disorders such as Schizophrenia, Bipolar, or Depression. The last dataset contains key information on environmental exposures and energy consumption Factors: amount of electricity generated from fossil fuels, renewable energy, or nuclear; Percentage of population got access to electricity/cooking fuel; Energy amount consumed. Since DALYs as we define heavily related on the population of a country, we want to redefine our variable of interest as percentage of DALYs due to a specific reason to remove the skewness of DALYs due to population. Hence, our new variable of interests are:

$$\%DALY_{Noncomm} = \frac{DALYs\ due\ to\ Noncommunicable\ Disease\ (in\ Years)}{Total\ DALYs\ (in\ Years)}$$

$$\%DALY_{Comm} = \frac{DALYs\ due\ to\ Communicable\ Disease\ (in\ Years)}{Total\ DALYs\ (in\ Years)}$$
```{r data, cache=TRUE}
dataDir <- "~/STAT209/Final/Data"

countryDir <- paste(dataDir, "countryClean.csv", sep = "/")

country_tidy <- read_csv(countryDir, skip = 43)
country_label <- read_csv(countryDir, n_max = 42) |> dplyr::select(variable, label)
```

```{r dataLabel, cache=TRUE}
country_tidy <- country_tidy |> apply_labels(
  Entity = "Country Name",
  Code = "Country Short",
  Year = "Year", 
  Region = "Continient Location",
  IncomeGroup = "Income Group",
  Latitude = "Latitude of the Country",
  Longitude = "Longitude of the Country",
  Density = "Population density per square kilometer (Pop/Km2)",
  LandArea = "Total land area in square kilometers (Km2)",
  GdpGrowth = "Annual GDP growth rate based on local currency (%)",
  GdpPerCapita = "Gross domestic product per person (GDP/capita)",
  
  Schizophrenia = "Schizophrenia Disorder(% Pop)",
  Bipolar = "Bipolar Disorder(% Pop)",
  Eating = "Eating Disorder(% Pop)",
  Anxiety = "Anxiety Disorder(% Pop)",
  DrugUse = "Substance Use Disorder(% Pop)", 
  Depressive = "Depressive Disorder(% Pop)",
  AlcoholUse = "Alcohol Use Disorder(% Pop)",
  ElecAcc = "Access to Electricity(% Pop)",
  CookFuelAcc = "Access to Clean Cooking Fuel(% Pop)",
  Undernorish = "Undernorished(% Pop)",
  
  HealthExp = "Health expenditure (% of GDP)",
  EducExp = "Education expenditure (% of GDP)",
  Unemployment = "Labor force that is without work  (% labor force)",
  
  LifeExpectancy = "Life Expectancy (Year)",
  DalyInjure = "DALYs due to Injuries (Year)",
  DalyComm = "DALYs due to Communicable diseases (Year)",
  DalyNoncomm = "DALYs due to Non-Communicable diseases (Year)",
  DalyCommPct = "Percentage of DALYs due to Communicable diseases (%)",
  DalyNoncommPct = "Percentage of DALYs due to Non-Communicable diseases (%)",
 
  Co2 = "Carbon dioxide emissions (kiloton)",
  ReElecGen = "Generating capacity of Renewable electricity (W/capita)",
  
  ElecFossilFuels = "Fossil Fuels Electricity (TWh)",
  ElecNuclear = "Nuclear Electricity (TWh)",
  ElecRenewables = "Renewable Electricity (TWh)",
  
  ReEnergyPct = "Renewable Energy in total energy consumption (% Energy)",
  LowCarbon = "Electricity from low-carbon sources (% Energy)",
  RenewGen = "Has Renewable electricity generator",
  
  PersonConsume =  "Energy consumption per person (kWh/person)",
  EconomyConsume = "Energy use per unit of GDP at purchase power parity (PPP GDP)",
  
  Invested = "Has FDI for clean energy",
  FDIClean = "FDI for clean energy (USD)")
```

## Data Summary

We did an inner join of all the datasets and ended up with 1,944 observations with 34 attributes from 112 countries, with a time span from 2001 to 2019. Table \@ref(tab:statSummaryTable) provides a comprehensive guide of the meaning and units of measurement for each variable.

```{r varSum}
options(knitr.kable.NA = '-')

cont_table <- country_tidy |>
  tab_cells(Schizophrenia, Bipolar, Eating, Anxiety,
            DrugUse, Depressive, AlcoholUse, 
            Density, LandArea, GdpGrowth, GdpPerCapita,
            Undernorish, HealthExp, EducExp, Unemployment,
            ElecAcc, CookFuelAcc, LifeExpectancy,
            DalyCommPct, DalyNoncommPct,
            Co2, ReElecGen,
            ElecFossilFuels, ElecNuclear, ElecRenewables,
            ReEnergyPct, LowCarbon,
            PersonConsume, EconomyConsume, FDIClean) |>
  tab_stat_fun(
    "Median" = w_median, "Mean" = w_mean,
    "Std. dev." = w_sd, "Valid N" = w_n, method = list) |>
  tab_pivot() |>
  expss::split_table_to_df() 
cate_count <- rbind(
  country_tidy |> count(Region) |> rename(var = Region),
  country_tidy |> count(IncomeGroup) |> rename(var = IncomeGroup),
  country_tidy |> count(Invested) |> rename(var = Invested),
  country_tidy |> count(RenewGen) |> rename(var = RenewGen)) |>
  mutate(Mean = NA, Median = NA, SD = NA) |>
  select(var, Mean, Median, SD, n)

cont_table <- cont_table[-c(1, 2),]
rownames(cont_table) <- NULL
colnames(cont_table) <- c("Variable", "Median", 
                          "Mean", "Std. Dev.", "Count")

colnames(cate_count) <- c("Variable", "Median", 
                   "Mean", "Std. Dev.", "Count")
```
```{r statSummaryTable, message = TRUE}
rbind(cont_table, cate_count) |>
  mutate(
    Mean = as.numeric(Mean),
    `Std. Dev.` = as.numeric(`Std. Dev.`),
    Count = as.numeric(Count),
    Median = as.numeric(Median)) |>
  kable(digits = 3, align = "lcccc", 
        format.args = list(big.mark = ","), 
        format = "latex", linesep = "",
        caption = "Summary Statistic Table") |> 
  group_rows("Mental Illness (Continuous)", 1, 7) |>
  group_rows("Country Info (Continuous)", 8, 20) |>
  group_rows("Energy (Continuous)", 21, 30) |>
  group_rows("Country Info (Categorical)", 31, 40) |>
  group_rows(var_lab(country_tidy$Region), 31, 36,
             bold = F, label_row_css = "") |>
  group_rows(var_lab(country_tidy$IncomeGroup), 37, 40,
             bold = F, label_row_css = "") |>
  group_rows("Energy (Categorical)", 41, 44) |>
  group_rows(var_lab(country_tidy$Invested), 41, 42,
             bold = F, label_row_css = "") |>
  group_rows(var_lab(country_tidy$RenewGen), 43, 44,
             bold = F, label_row_css = "") |>
  add_header_above(c(" " = 1, "Statistical Summary" = 4), 
                     align = "c") |>
  kable_styling(full_width = F, font_size = 8)
```

\pagebreak
# Analytic Framework

In order to check for statistical significance and multicollinearity, we utilized a world heatmap (Figure \@ref(fig:worldPreliminary)) for the two types of diseases and a correlation table (Figure \@ref(fig:correlationTable)) for all the explanatory variables. This would give us some insights into the distribution of diseases, possible explanations for such patterns, as well as weeding out irrelevant variables.

## DALYs Distribution

Figure \@ref(fig:worldPreliminary) gives us a visualization of DALYs distribution, broken down to communicable diseases and noncommunicable diseases. Our assumption is that Region is a significant factor in affecting the percentage of DALYs, and that DALYs vary between continents. Upon inspection, we can see that Sub-Sahara and Africa areas observed a much higher distribution of DALYs due to communicable disease. This might be due to the lack of health resources and protocols as well as higher prevalence of deadly diseases (malaria,tuberculosis) due to specific geographical and environmental diseases. This would result in higher fatality for communicable diseases. On the contrary, we noticed a higher concentration of DALYs due to non-communicable diseases in Europe and North America. 

```{r worldData}
world_map <- map_data("world") |> 
  rename("Entity" = "region") |> apply_labels(Entity = "Country Name")

world_vis <- country_tidy |> filter(Year == 2013) |>
  dplyr::select(Entity, DalyCommPct, DalyNoncommPct) |>
  right_join(world_map, by = "Entity") 
```

```{r worldPreliminary, fig.height = 12, fig.width = 8, message = TRUE, fig.cap = "DALYs due to (Non)communicable distribution across continents in 2013"}
 (ggplot(world_vis) +
   geom_map(aes(map_id = Entity, fill = DalyCommPct, 
                alpha = is.na(DalyNoncommPct)),
            map = map_data("world"), show.legend = F) + 
   scale_alpha_manual(values = c("TRUE" = 0.5, "FALSE" = 1), guide = FALSE) +
   scale_fill_continuous(limits = c(0, 100), low = "lightblue", high = "darkblue") +
   expand_limits(x = world_vis$long, y = world_vis$lat) +
   theme(
      axis.text.y = element_blank(), axis.ticks.y = element_blank(),
      axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
   labs(y = var_lab(country_tidy$DalyCommPct), x = "",
        title = "World Visualization for DALYs Percentages")) /
 (ggplot(world_vis) +
   geom_map(aes(map_id = Entity, fill = DalyNoncommPct, 
                alpha = is.na(DalyCommPct)),
            map = map_data("world")) + 
   scale_alpha_manual(values = c("TRUE" = 0.5, "FALSE" = 1), guide = FALSE) + 
   scale_fill_continuous(limits = c(0, 100), low = "lightblue", high = "darkblue") +
   theme(
      axis.text.y = element_blank(), axis.ticks.y = element_blank(),
      axis.text.x = element_blank(), axis.ticks.x = element_blank(),
      legend.position = "bottom") +
   labs(y = var_lab(country_tidy$DalyNoncommPct), x = "",
        fill = "DALYs due to (Non) \nCommunicable Diseases") + 
   expand_limits(x = world_vis$long, y = world_vis$lat) +
  guides(fill = guide_colorbar(barwidth = 20, barheight = 0.5)))
```

## DALYs relationship with other variables

Figure \@ref(fig:correlationTable) gives us the correlation between each type of disease and variables of interest. The strongest correlation for non-communicable diseases are: Schizophrenia (positive), LifeExpectancy(positive), Undernourished (negative), Electricity Access (positive), Cooking Fuel Access (positive), Has Renewable Energy Generator or not (negative). The strongest correlation for non-communicable diseases are: Schizophrenia (negative), LifeExpectancy(negative), Undernourished (positive), Electricity Access (negative), Cooking Fuel Access (negative). Later on, we will implement our supervised learning strategies to confirm these findings. 

```{r corTableGen}
corTable <- country_tidy[,-c(1)] |>
  dplyr::select(-c(Code, Region, IncomeGroup, Latitude, Longitude, 
                   Invested, RenewGen, Year, Density, LandArea, 
                   DalyInjure, DalyComm, DalyNoncomm)) |> cor()
```
```{r correlationTable, fig.height=10, fig.width=10, fig.cap = "DALYs correlation with other variables", message=TRUE}
(corTable[1:8, 27:28] |> reshape2::melt(na.rm = T) |>
  ggplot(aes(x = Var1, y = Var2, fill = value)) +
    geom_tile() +
    scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                         midpoint = 0, limit = c(-1,1), space = "Lab", 
                         name="Pearson\nCorrelation") +
    theme(
      axis.text.x = element_text(angle = 60, vjust = 0.5, 
                                 size = 10, hjust = 0.5),
      axis.text.y = element_text(angle = 0, vjust = 1, 
                                 size = 10, hjust = 1),
      axis.title.x = element_blank(), axis.title.y = element_blank()) + 
  coord_fixed() +
  guides(fill="none")) /
(corTable[9:18, 27:28] |> reshape2::melt(na.rm = T) |>
  ggplot(aes(x = Var1, y = Var2, fill = value)) +
    geom_tile() +
    scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                         midpoint = 0, limit = c(-1,1), space = "Lab", 
                         name="Pearson\nCorrelation") +
    theme(
      axis.text.x = element_text(angle = 60, vjust = 0.5, 
                                 size = 10, hjust = 0.5),
      axis.text.y = element_text(angle = 0, vjust = 1, 
                                 size = 10, hjust = 1),
      axis.title.x = element_blank(), axis.title.y = element_blank()) + 
  labs(title = "") +
  coord_fixed()) +
(corTable[19:26, 27:28] |> reshape2::melt(na.rm = T) |>
  ggplot(aes(x = Var1, y = Var2, fill = value)) +
    geom_tile() +
    scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                         midpoint = 0, limit = c(-1,1), space = "Lab", 
                         name="Pearson\nCorrelation") +
    theme(
      axis.text.x = element_text(angle = 60, vjust = 0.5, 
                                 size = 10, hjust = 0.5),
      axis.text.y = element_text(angle = 0, vjust = 1, 
                                 size = 10, hjust = 1),
      axis.title.x = element_blank(), axis.title.y = element_blank()) + 
  labs(title = "") +
  coord_fixed() + 
  guides(fill="none"))
```

## Model Implementation

In order to identify statistically significant variables to utilize for our regressions, we used Lasso and OLS. The research employs Ordinary Least Squares (OLS) for its simplicity and efficiency in estimating linear regression model parameters, useful for determining the strength and nature of relationships between dependent and independent variables. Lasso Regression is utilized as a regularization technique to enhance prediction accuracy and interpretability by shrinking the coefficients of less important variables to zero, which comes in handy for our models with many predictors. 

We will conduct our model implementation to both DALYs due to noncommunicable diseases and communicable disease simultaneously. To confirm our hypothesis, our LASSO models will initially use all explanatory variables as predictors with large $\lambda$ to reveal standout variables to DALYs due to (non)communicable disease. After that, we want to quantify these variables' impact using OLS regression. Other than significant variables shown in the LASSO models, we want to include time effect (Year) and regional effect (Region) in the model as predictors. 

\pagebreak
# Results

```{r dataSplit}
set.seed(1304)
country_split <- initial_split(country_tidy, prop = 4/5)
country_train <- training(country_split)
country_test  <- testing(country_split)
```

## Feature Selection

From our initial LASSO model, we chose $log(\lambda) = 1$ for both models and identified 6 variables that impact noncommunicable diseases DALYs (Figure \@ref(fig:noncommLassoInit)) and 9 variables impact communicable diseases (Figure \@ref(fig:commLassoInit)). Choosing a relatively high $\lambda$ comes with some drawbacks on our cross-validated MSE, but it also gives us a better understanding of what variable to focus on in later model as well as improving the robustness of the model in general.

```{r noncommFormula}
noncomm_formula <- as.formula(
  DalyNoncommPct ~ 
    (Year + LifeExpectancy + Co2 + Undernorish + 
     HealthExp + EducExp + Unemployment + GdpGrowth + GdpPerCapita +
     Schizophrenia + Bipolar + Eating + Anxiety + 
     DrugUse + Depressive + AlcoholUse)*(Region + IncomeGroup + 1) +
     Region + IncomeGroup + Region:IncomeGroup)

noncomm_resp <- country_train |> dplyr::select(DalyNoncommPct) |> pull()
noncomm_exp_vars <- model.matrix(noncomm_formula, country_train)
noncomm_penalty <- c(1, 0, rep(1, length(colnames(noncomm_exp_vars))-2))
```

```{r commFormula}
comm_formula <- as.formula(
  DalyCommPct ~
    (Year + LifeExpectancy + Co2 + Undernorish +
     HealthExp + EducExp + Unemployment + GdpGrowth + GdpPerCapita +
     ElecAcc + CookFuelAcc + ElecFossilFuels + FDIClean +
     ElecNuclear + ElecRenewables + LowCarbon + PersonConsume + EconomyConsume
     )*(Region + IncomeGroup + Invested + RenewGen + 1) +
     Region + IncomeGroup + Invested + RenewGen)

comm_resp <- country_train |> dplyr::select(DalyCommPct) |> pull()
comm_exp_vars <- model.matrix(comm_formula, country_train)
comm_penalty <- c(1, 0, rep(1, length(colnames(comm_exp_vars))-2))
```

```{r fitModels}
set.seed(1000)
cv_noncomm_model <- cv.glmnet(x = noncomm_exp_vars, y = noncomm_resp, 
                              alpha = 1, penalty.factor = noncomm_penalty)

cv_comm_model <- cv.glmnet(x = comm_exp_vars, y = comm_resp, 
                           alpha = 1, penalty.factor = comm_penalty)
```

## Final LASSO & OLS Model

For our non-communicable diseases LASSO model, we were able to narrow down to: Schizophrenia (% population- continuous), and Undernourished (% population- continuous). It can be deduced that mental illnesses that are characterized by irrational actions and high risk level (Schizophrenia), and undernourishment, are significant drivers of non-communicable DALYs. For our communicable model, we identified Electricity Access (% population, continuous), Cooking Fuel Access (% population, continuous), Has Renewable Energy Generator or not (binary), Has investment for FDI on renewable energy or not (binary). This model agrees with previous literature on the effects of byproducts through energy consumption on physical diseases. Life Expectancy (number of years, continuous), Time (Years, continuous), and Continent (categorical) are statistically significant explanatory variables in both models. This finding shows strong evidence on how DALYs is impacted regionally. Other evidences shows regional influences on DALYs are interactions between Bipolar with Sub-Sahara Africa region (Figure) in the non-communicable diseases model and interaction between Electricity Accessibility with Europe-Central Asia. Therefore quantify these impact, we finalize our OLS model with variables appears in individually and in interaction terms. We want to look at how each of these variables contributes to DALYs separately; therefore, our OLS model will only consist their fixed effect terms

$$DALY_{Noncomm} = Year + LifeExpectancy + Region + Schizophrenia + Bipolar + Undernourished$$
$$DALY_{Comm} = Year + LifeExpectancy + Region + ElecAcc + CookFuelAcc + RenewGen + Invested$$

Table \ref{tab:noncomm_coef} and \ref{tab:comm_coef} shows the coefficients for both LASSO and OLS models in comparison. We can see that the OLS model showcase stronger coefficients for both non-communicable and communicable diseases model. This is because LASSO put a heavy penalty on the coefficient, which help to regularize the coefficient and somewhat hinder our interpretation for variables' effects. Another disadvantage from the LASSO model we can see from the communicable disease model is that many coefficients is close to zero, which does not helpful for our investigation eventhough they are standout compared to other variables. Therefore, we will only focus on interpreting the effect of predictors on the OLS model.


```{r noncommLassoInit, message = TRUE, fig.cap = "Noncommunicable disease LASSO models decision for chosen $\\lambda$", fig.height = 4, fig.width = 6}
plot(cv_noncomm_model)
abline(v = 1)
```

```{r commLassoInit, message = TRUE, fig.cap = "Communicable disease LASSO models decision for chosen $\\lambda$", fig.height = 4, fig.width = 6}
plot(cv_comm_model)
abline(v = 1)
```

\pagebreak

## Model Interpretation

### Non-communicable Disease Model

For non-communicable disease OLS model, we found that Schizophrenia is the most impactful predictors among mental health and socio-economic factors. Given in Table \ref{tab:noncomm_coef}, a percentage point increase of Schizophrenia population leads to an increase of 94.584 percentage point of DALYs due to non-communicable disease. Although the coefficient is large, we can see that from Table \@ref(statSummaryTable), Schizophrenia does not have wide spread (St. Dev. Schizophrenia $\approx$ 0). In other words, Schizophrenia is a still good predictor of DALYs due to non-communicable diseases but the lack of variation poses an issue, in particular a relatively “constant” effect for non-communicable disease DALYs. On the other hand, a percentage point increase in Bipolar population leads to 5.324 decrease of percentage point in DALYs due to non-communicable diseases. This finding contradicts with what we hypothesized earlier (positive correlation). 

Regarding region, our model also shows the coefficient’s difference between regions’ coefficients, where Europe and Central Asia (coef = 11.668) has greater shares of non-communicable diseases than Sub-Saharan Africa or South Asia (-9.95 and -8.994, respectively). We can see that as Life Expectancy of a country increases, non-communicable DALYs also increase. This suggests that as people live longer, we would expect better treatment of communicable disease due to advanced health technology. However, access to technology and automation isn't always a good thing, as it could lead to an increased portion of non-communicable disease (eg: processed food, social meida, etc). Figure \@ref(fig:halfeyeNoncomm) portraits the relative distribution of both life expectancy and non-communicable disease, showing strong evidence of positive correlation across regions.

```{r noncommLassoRefit}
refit_noncomm_penalty <- c(0, rep(1, length(colnames(noncomm_exp_vars))-2))

lasso_noncomm <- linear_reg(penalty = exp(1), mixture = 1) |>
  set_engine("glmnet", penalty.factor = refit_noncomm_penalty) |>
  fit(noncomm_formula, data = country_train)

lasso_noncomm_coef <- lasso_noncomm |> 
  tidy() |> filter(estimate != 0) |>
  rename(LASSO = estimate) |> select(-penalty)
```
```{r commLassoRefit}
refit_comm_penalty <- c(0, rep(1, length(colnames(comm_exp_vars))-2))

lasso_comm <- linear_reg(penalty = exp(1), mixture = 1) |>
  set_engine("glmnet", penalty.factor = refit_comm_penalty) |>
  fit(comm_formula, data = country_train)

lasso_comm_coef <- lasso_comm |> 
  tidy() |> filter(estimate != 0) |>
  rename(LASSO = estimate) |> select(-penalty)
```
```{r noncommOLS}
ols_noncomm_formula <- as.formula(
  DalyNoncommPct ~ Year + LifeExpectancy + Undernorish + 
    Bipolar + Schizophrenia + Region)

ols_noncomm <- linear_reg() |>
  set_engine("lm") |>
  fit(ols_noncomm_formula, data = country_train)

ols_noncomm_coef <- ols_noncomm |> tidy() |> 
  rename(OLS = estimate) |> select(term, OLS)
```
```{r commOLS}
ols_comm_formula <- as.formula(
  DalyCommPct ~ Year + LifeExpectancy + ElecAcc + 
    CookFuelAcc + Invested + RenewGen + Region)

ols_comm <- linear_reg() |>
  set_engine("lm") |>
  fit(ols_comm_formula, data = country_train)

ols_comm_coef <- ols_comm |> tidy() |> 
  rename(OLS = estimate) |> select(term, OLS)
```
```{r noncommEval}
augmented_noncomm_ols <- ols_noncomm |> augment(new_data = country_test) |>
  select(.pred, .resid, DalyNoncommPct) |> mutate(Model = "OLS") 

augmented_noncomm_lasso <- lasso_noncomm |> augment(new_data = country_test) |>
  select(.pred, .resid, DalyNoncommPct) |> mutate(Model = "LASSO")

augmented_noncomm <- augmented_noncomm_ols |> add_row(augmented_noncomm_lasso)

noncomm_metric <- augmented_noncomm |> group_by(Model) |> 
  summarize(MSE = round(mean(.resid^2), 3),  
            mst = mean((mean(DalyNoncommPct) - DalyNoncommPct)^2),
            `R-square` = round(1 - MSE/mst, 3)) |>
  select(-mst) |> pivot_longer(-Model) |>
  pivot_wider(name, names_from="Model",
              values_from="value") |>
  rename(Variable = name)
```
```{r commEval}
augmented_comm_ols <- ols_comm |> augment(new_data = country_test) |>
  select(.pred, .resid, DalyCommPct) |> mutate(Model = "OLS") 

augmented_comm_lasso <- lasso_comm |> augment(new_data = country_test) |>
  select(.pred, .resid, DalyCommPct) |> mutate(Model = "LASSO")

augmented_comm <- augmented_comm_ols |> add_row(augmented_comm_lasso)

comm_metric <- augmented_comm |> group_by(Model) |> 
  summarize(MSE = round(mean(.resid^2), 3),  
            mst = mean((mean(DalyCommPct) - DalyCommPct)^2),
            `R-square` = round(1 - MSE/mst, 3)) |>
  select(-mst) |> pivot_longer(-Model) |>
  pivot_wider(name, names_from="Model",
              values_from="value") |>
  rename(Variable = name)
```
```{r modelCoefFormat}
noncomm_coef <- ols_noncomm_coef |> merge(lasso_noncomm_coef, all = TRUE) |> 
  arrange(-LASSO, OLS) |>
  mutate(OLS = as.character(round(OLS, 3)),
         LASSO = as.character(round(LASSO, 3)),
         term = str_remove_all(term, "Region")) |>
  rename(Variable = term)

noncomm_coef <- noncomm_coef[c(1, 10, 3, 5, 4, 2, 8, 9, 11, 12, 7, 6),]

noncomm_coef <- noncomm_coef|> add_rows(noncomm_metric)

comm_coef <- ols_comm_coef |> merge(lasso_comm_coef, all = TRUE) |> 
  arrange(-LASSO, OLS) |>
  mutate(OLS = as.character(round(OLS, 3)),
         LASSO = as.character(round(LASSO, 3)),
         term = str_remove_all(term, "Region")) |>
  rename(Variable = term)

comm_coef <- comm_coef[c(7, 8, 9, 2, 4, 3, 10, 1, 14, 13, 12, 6, 5, 11),]

comm_coef <- comm_coef |> add_rows(comm_metric)

noncomm_table <- xtable(noncomm_coef, 
             caption = "DALYs due to Noncommunicable Diseases Coefficients", 
             label = "tab:noncomm_coef", align = "rl|cc")

comm_table <- xtable(comm_coef, 
             caption = "DALYs due to Communicable Diseases Coefficients", 
             label = "tab:comm_coef", align = "rl|cc")
```
```{r noncommTable, results='asis', message = TRUE}
print(noncomm_table, include.rownames = FALSE, comment = FALSE,
      hline.after = c(-1, 0, nrow(noncomm_coef)-2, nrow(noncomm_coef)))
```

```{r commTable, results='asis', message = TRUE}
print(comm_table, include.rownames = FALSE, comment = FALSE,
      hline.after = c(-1, 0, nrow(comm_coef)-2, nrow(comm_coef)))
```

### Communicable Disease Model

Although we found more significant predictors for the communicable disease variables, no variables shows large impact similar to Schizophrenia in the other model for non-communicable disease model. Our two most significant environmental factors are Has Renewable Energy Generator or not and Has investment for FDI on renewable energy or not. This highlights the importance of the transitioning energy type. We also saw that both Electric and Cooking Fuel Accessibility has a negative coefficient with communicable disease DALYs. In contrast with non-communicable disease model, the regional effect on DALY is the greatest in  Sub-Saharan Africa (coef: 17.65), followed by South Asia (coef: 9.938) and the least is Europe - Central Asia
(coef: -2.918). These findings generally agrees with our findings for non-communicable diseases model. DALYs decrease with higher access to healthcare and clean energy. Once again, life expectancy has a negative correlation with communicable disease. This also show evidences that DALYs portions shift from communicable disease to non-communicable disease more as life expectancy increase. 

```{r halfeyeNoncomm, fig.height = 3.75, fig.width = 10, fig.cap = "DALYs due to Noncommunicable Disease and Life Expectancy Distribution across regions"}
ggplot(country_train, aes(x = DalyNoncommPct, y = Region)) +
  stat_halfeye() +
  labs(x = var_lab(country_train$DalyNoncommPct)) +
ggplot(country_train, aes(x = LifeExpectancy, y = Region)) +
  stat_halfeye() +
  labs(x = var_lab(country_train$LifeExpectancy)) + 
  theme(axis.title.y = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank())
```

## Evaluation

From table \ref{tab:noncomm_coef} and \ref{tab:comm_coef}, we can see that our MSE for the model is around 50, which is high compared to a model with a response variable as percentage point. This implies some systematic errors on our models as we only evaluate a simple OLS regression. Despite a large MSE, our model got a significantly large R-square value across 4 models (> 0.9), suggesting that our predictors are unable to explain the variation from the response variable. On the other note, we can see from figure \@ref(fig:noncommExamPlot) and \@ref(fig:commExamPlot), both LASSO and OLS model produce an upward trend in the residual plot. This can mean that our model has yet truly capture some complex trend between DALYs and mental health, energy consumption, and socio-economic factor. We think that our model could be improved by using more advance model such as Mixed-Effect Model or difference-in-difference strategy to better quantify the regional effect on our response and predictor variables.

```{r noncommExamPlot, fig.cap = "Residual vs. Actually Non-communicable Disease DALYs Plot", message = TRUE, fig.height = 4, fig.width = 6}
ggplot(augmented_noncomm, aes(x = DalyNoncommPct, y = .resid, color = Model)) + 
  geom_point(alpha = 0.4) +
  geom_smooth(formula = y ~ x, method = "lm", se = F) +
  theme(legend.position = "top") +
  labs(y = "Residual", x = var_lab(country_test$DalyNoncommPct))
```

```{r commExamPlot, fig.cap = "Residual vs. Actually Communicable Disease DALYs Plot", message = TRUE, fig.height = 4, fig.width = 6}
ggplot(augmented_comm, aes(x = DalyCommPct, y = .resid, color = Model)) + 
  geom_point(alpha = 0.4) +
  geom_smooth(formula = y ~ x, method = "lm", se = F) +
  theme(legend.position = "top") +
  labs(y = "Residual", x = var_lab(country_test$DalyCommPct))
```

\pagebreak

# Implications

In summary, we think that our study has capture the essense of DALYs:
\begin{enumerate}
  \item For mental health factor, schizophrenia shows the most impact to non-communicable disease DALYs.
  \item For energy consumption, electricity and cooking fuel accessibility reduce communicable disease DALYs.
  \item For socio-economic factor, life expectancy reduce communicable disease DALYs while increse non-communicable disease DALYs.
  \item Regional location has impact on not just DALYs but also has complex relationship with socio-economic, mental healths and energy consumption factors
\end{enumerate}

With these findings, we believe that DALYs caused by mental health issues, specifically those caused by neurodivergence, cannot be avoided in nature. There could be medications that address the issue, but that is only the tip of the iceberg. Our solution to reduce DALYs in general would be to allocate resources on addressing communicable diseases. By allocating emergency heathcare forces to areas of need and ensure clean, usable energy, we can gradually improve life expectancy and reduce chance of premature death due to communicable disease. It is important to note that our project focuses on studying the relative proportions of diseases in comparison to each other, rather than analyzing them individually. This means that if we can minimize total DALYs by reducing communicable DALYs.

Our research indicates that various regions should adopt tailored strategies to reduce their burden of disability-adjusted life years (DALYs). For instance, Sub-Saharan Africa faces a greater prevalence of communicable disease. For example, a few methods to combat malaria, one of the most deadly diseases in these areas, include but are not limited to: structured vaccination programs, mosquito net distribution, and antiretroviral therapy access.

Conversely, regions like Europe and Central Asia might focus on enhancing mental health care to address non-communicable disease DALYs. This could involve increasing access to counseling services, promoting awareness campaigns to reduce stigma around mental health issues, and integrating mental health screening into primary care settings.




